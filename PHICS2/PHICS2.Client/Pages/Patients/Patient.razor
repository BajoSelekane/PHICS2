@page "/patients/create"
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Elevation="8" Class="pa-6">

        <MudText Typo="Typo.h5" Class="mb-4">
            Register New Patient
        </MudText>

        <MudForm @ref="_form" Model="_model" OnValidSubmit="Submit">

            <MudTextField Label="ID Number"
                          For="@(() => _model.IDNumber)"
                          Required="true"
                          Immediate="true" />

            <MudTextField Label="Full Name"
                          For="@(() => _model.PatientName)"
                          Required="true" />

            <MudTextField Label="Email"
                          For="@(() => _model.Email)" />

            <MudTextField Label="Phone Number"
                          For="@(() => _model.PhoneNumber)"
                          Required="true" />


            <MudDatePicker T="DateTime?"
                           Label="Date of Birth"
                           @bind-Date="_model.DateOfBirth"
                           For="@(() => _model.DateOfBirth)" 
                           Required="false" />
                        

            <MudTextField Label="Appointment Description"
                          @bind-Value="_model.Appointment_Description"
                          For="@(() => _model.Appointment_Description)"
                          Lines="3"
                          Variant="Variant.Outlined" />



            <MudButton Type="Submit"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="mt-4"
                      
                       Disabled="_loading">

                @if (_loading)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                    <span>Saving...</span>
                }
                else
                {
                    <span>Create Patient</span>
                }

            </MudButton>

        </MudForm>

    </MudPaper>
</MudContainer>

@code {

    private MudForm _form;
    private bool _loading;

    private CreatePatientModel _model = new();

    private async Task Submit()
    {
        await _form.Validate();

        if (!_form.IsValid)
            return;

        try
        {
            _loading = true;

            var response = await Http.PostAsJsonAsync("patients", _model);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Patient created successfully", Severity.Success);
                var result = await response.Content.ReadFromJsonAsync<Guid>();
                Nav.NavigateTo($"/patients/{result}");

                //Nav.NavigateTo("/patients");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add(error, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    public class CreatePatientModel
    {
        [Required]
        public string IDNumber { get; set; }

        [Required]
        public string PatientName { get; set; }

        public string? Email { get; set; }

        [Required]
        public string PhoneNumber { get; set; }

        
        // Make nullable to match the MudDatePicker T="DateTime?" and because it's optional
        public DateTime? DateOfBirth { get; set; }

        public string? Appointment_Description { get; set; }
    }
}
